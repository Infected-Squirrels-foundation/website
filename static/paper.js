// Generated by CoffeeScript 1.3.3
(function() {

  $(function() {
    var real_editor;
    window.bcpl = window.bcpl || {};
    window.bcpl.interpret = _.debounce(function() {
      if ($('#teletype').val().length % 10 === 0) {
        $('.stdout').html('loading...');
        return $.post('/interpret', {
          code: $('#teletype').val()
        }, function(res) {
          return $('.stdout').html(res);
        });
      } else {
        return $('.stdout').html("wrong input length (need " + (10 - $('#teletype').val().length % 10) + " more)");
      }
    }, 100);
    window.bcpl.go = function() {
      var editor_height, line_width, val;
      line_width = $('.width_template').width();
      editor_height = $('#teletype').height();
      $('#teletype').hide();
      $('.buttons').hide();
      $('.stdout').hide();
      $('#teletype').hide();
      $('.highlight').hide();
      val = $('.highlight').html();
      $('<div class=\"paper\"></div>').appendTo('.paper_wrap').css({
        'min-height': editor_height
      }).html(val);
      return setTimeout(function() {
        return $('.paper').css({
          width: line_width
        }).afterTrans(500, function() {
          val = $('#teletype').val();
          val = val.replace(/(\d{2})(\d{3})/g, '$1:$2');
          val = val.replace(/1/g, '●');
          val = val.replace(/0/g, '&nbsp;');
          $('.paper').html(val).css({
            background: 'url(/static/paper_fibers.png)',
            'line-height': '.6em'
          });
          return $('.paper_wrap').css({
            top: -($('.paper_wrap').height() + $('.paper_wrap').offset().top * 1.1)
          }).afterTrans(function() {
            $('.paper').text('●:●●●●●:●●●●●:● ● ●: ● ● :● ●');
            return $('.paper_wrap').css({
              top: 0
            }).afterTrans(function() {
              return $('.paper').css({
                width: 900
              }).afterTrans(function() {
                $('.paper_wrap').hide();
                $('.workspace').css('text-align', 'center');
                return window.bcpl.save();
              });
            });
          });
        });
      }, 500);
    };
    window.bcpl.save = function() {
      $.post('/save', {
        code: $('#teletype').val()
      }, function(id) {
        var _ref;
        if ((_ref = window.history) != null) {
          _ref.pushState(0, 0, id);
        }
        return $("<h1><a href=\"/" + id + "\">" + window.location.href + "</a></h1>").appendTo('.workspace');
      });
      return true;
    };
    $.fn.afterTrans = function(extra_duration, func) {
      if (typeof extra_duration === 'function') {
        func = extra_duration;
        extra_duration = 0;
      }
      return this.each(function() {
        return $(this).on('transitionend webkittransitionend moztransitionend', function() {
          return setTimeout(function() {
            return func.call(this);
          }, extra_duration);
        });
      });
    };
    real_editor = $('#teletype');
    $('.highlight').width(real_editor.width());
    $('.highlight').height(real_editor.height());
    $('#teletype').on('keyup', function() {
      return $('.highlight').html($(this).val());
    });
    window.bcpl.highlight_1 = function() {
      var hl;
      $('.highight_btn').attr('onClick', 'bcpl.highlight_2()');
      $('.highight_btn').text('more colors');
      $('.highlight').css({
        color: 'black'
      });
      $('#teletype').css({
        color: 'transparent'
      });
      hl = function() {
        var val;
        val = $('#teletype').val();
        val = val.replace(/(\d{5})(\d{1,5})/g, '<span style="font-weight:bold">$1</span><span style="font-weight:bold;color: grey;" class="operand">$2</span>');
        return $('.highlight').html(val);
      };
      hl();
      return $('#teletype').on('keyup', function() {
        return hl();
      });
    };
    return window.bcpl.highlight_2 = function() {
      var hl;
      $('.highight_btn').text('that\'s enought');
      $('.highight_btn').attr('disabled', 'disabled');
      $('.highlight').css({
        'font-weight': 'bold'
      });
      $('#teletype').css({
        color: 'transparent'
      });
      hl = function() {
        var val;
        val = $('#teletype').val();
        val = _.map(val, function(s) {
          return "<span style=\"color:hsl(" + (Math.random() * 180) + ",80%,40%);font-weight:bold\" class=\"operand\">" + s + "</span>";
        });
        return $('.highlight').html(val);
      };
      hl();
      return $('#teletype').on('keyup', function() {
        return hl();
      });
    };
  });

}).call(this);
